<!-- templates/batch_study.html -->
{% extends "base.html" %}

{% block title %}æ‰¹æ¬¡å­¦ä¹  - è®°å¿†åŠ©æ‰‹{% endblock %}

{% block content %}
<div class="container">
    <div class="study-header">
        <h2>æ‰¹æ¬¡å­¦ä¹ </h2>
        <div class="session-info">
            <div class="session-progress">
                <span id="progressText">0/0</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="endStudyEarly()">æå‰ç»“æŸ</button>
        </div>
    </div>

    <div class="study-content" id="studyContent">
        <div class="loading-message">
            <p>åŠ è½½å­¦ä¹ å†…å®¹ä¸­...</p>
        </div>
    </div>

    <div class="study-input" id="studyInput" style="display: none;">
        <textarea id="userInput" placeholder="è¯·è¾“å…¥æ‚¨çš„ç­”æ¡ˆ..." rows="3"></textarea>
        <button class="btn btn-primary" onclick="submitAnswer()">æäº¤ç­”æ¡ˆ</button>
        <button class="btn btn-secondary" onclick="showAnswer()">æŸ¥çœ‹ç­”æ¡ˆ</button>
    </div>

    <div class="study-controls" id="studyControls" style="display: none;">
        <h3>æ‚¨ç­”å¯¹äº†å—ï¼Ÿ</h3>
        <div class="feedback-buttons">
            <button class="btn btn-easy" onclick="markAsTooEasy()">
                <span>å¤ªç®€å•äº†</span>
                <small>æˆ‘å·²ç»å®Œå…¨è®°ä½</small>
            </button>
            <button class="btn btn-remember" onclick="submitFeedback('remembered')">
                <span>ç­”å¯¹äº†</span>
                <small>æ­£ç¡®å›ç­”</small>
            </button>
            <button class="btn btn-forget" onclick="submitFeedback('forgotten')">
                <span>ç­”é”™äº†</span>
                <small>éœ€è¦å¤ä¹ </small>
            </button>
        </div>
    </div>
</div>

<script>
// å½“å‰å­¦ä¹ æ‰¹æ¬¡çŠ¶æ€
let currentBatch = {
    id: null,
    content: [],
    currentIndex: 0,
    startTime: Date.now()
};
let currentDeckId = {{ deck.id }};
// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const deckId = currentDeckId;
    startStudyBatch(deckId);
});

// å¼€å§‹å­¦ä¹ æ‰¹æ¬¡
async function startStudyBatch(deckId) {
    try {
        const response = await fetch('/api/study/batch/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                deck_id: parseInt(deckId),
                daily_goal: 20
            })
        });

        const result = await response.json();

        if (result.success) {
            currentBatch.id = result.batch_id;
            currentBatch.content = result.content;
            currentBatch.currentIndex = result.current_index;
            showCurrentContent();
            updateProgress();
        } else {
            showError(result.message || 'åŠ è½½å­¦ä¹ å†…å®¹å¤±è´¥');
        }
    } catch (error) {
        showError('ç½‘ç»œé”™è¯¯: ' + error.message);
    }
}

// æ˜¾ç¤ºå½“å‰å­¦ä¹ å†…å®¹
function showCurrentContent() {
    if (currentBatch.content.length === 0) {
        showEmptyState();
        return;
    }

    if (currentBatch.currentIndex >= currentBatch.content.length) {
        showCompletionState();
        return;
    }

    const content = currentBatch.content[currentBatch.currentIndex];

    document.getElementById('studyContent').innerHTML = `
        <div class="content-card">
            <div class="content-front">
                <h3>${escapeHtml(content.display_text)}</h3>
                ${content.example ? `<p class="example">${escapeHtml(content.example)}</p>` : ''}
            </div>
        </div>
    `;

    // æ˜¾ç¤ºè¾“å…¥æ¡†
    document.getElementById('studyInput').style.display = 'block';
    document.getElementById('studyControls').style.display = 'none';
    document.getElementById('userInput').value = '';
    document.getElementById('userInput').focus();

    currentBatch.startTime = Date.now();
}

// æäº¤ç­”æ¡ˆ
function submitAnswer() {
    document.getElementById('studyInput').style.display = 'none';
    showFeedbackControls();
}

// æ˜¾ç¤ºç­”æ¡ˆ
function showAnswer() {
    if (currentBatch.content.length === 0 || currentBatch.currentIndex >= currentBatch.content.length) {
        return;
    }

    const content = currentBatch.content[currentBatch.currentIndex];

    document.getElementById('studyContent').innerHTML = `
        <div class="content-card">
            <div class="content-front">
                <h3>${escapeHtml(content.display_text)}</h3>
                ${content.example ? `<p class="example">${escapeHtml(content.example)}</p>` : ''}
            </div>
            <div class="content-back">
                <h3>${escapeHtml(content.answer)}</h3>
                ${content.example ? `<p class="example">${escapeHtml(content.example)}</p>` : ''}
            </div>
        </div>
    `;

    document.getElementById('studyInput').style.display = 'none';
    showFeedbackControls();
}

// æ˜¾ç¤ºåé¦ˆæ§åˆ¶æŒ‰é’®
function showFeedbackControls() {
    document.getElementById('studyControls').style.display = 'block';
}

// æäº¤å­¦ä¹ åé¦ˆ
async function submitFeedback(feedbackType) {
    if (currentBatch.content.length === 0 || currentBatch.currentIndex >= currentBatch.content.length) {
        return;
    }

    const responseTime = Math.floor((Date.now() - currentBatch.startTime) / 1000);
    const currentContent = currentBatch.content[currentBatch.currentIndex];
    const userInput = document.getElementById('userInput').value;

    try {
        // è®°å½•å­¦ä¹ è¿›åº¦
        const response = await fetch('/api/study/batch/record', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                batch_id: currentBatch.id,
                content_id: currentContent.id,
                desk_id: currentDeckId,
                feedback_type: feedbackType,
                user_input: userInput,
                response_time: responseTime,
                is_correct: feedbackType === 'remembered'
            })
        });

        const result = await response.json();

        if (result.success) {
            moveToNextContent();
        } else {
            alert('æäº¤å¤±è´¥: ' + result.message);
        }
    } catch (error) {
        alert('è¯·æ±‚å¤±è´¥: ' + error.message);
    }
}

// æ ‡è®°ä¸ºå¤ªç®€å•
async function markAsTooEasy() {
    await submitFeedback('too_easy');
}

// ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå†…å®¹
function moveToNextContent() {
    currentBatch.currentIndex++;

    // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆ
    if (currentBatch.currentIndex >= currentBatch.content.length) {
        completeBatch();
        showCompletionState();
    } else {
        showCurrentContent();
        updateProgress();
    }
}

// å®Œæˆæ‰¹æ¬¡
async function completeBatch() {
    try {
        await fetch('/api/study/batch/complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                batch_id: currentBatch.id
            })
        });
    } catch (error) {
        console.error('å®Œæˆæ‰¹æ¬¡å¤±è´¥:', error);
    }
}

// æ›´æ–°è¿›åº¦æ¡
function updateProgress() {
    const total = Math.max(currentBatch.content.length, 1);
    const progress = (currentBatch.currentIndex / total) * 100;

    document.getElementById('progressFill').style.width = `${progress}%`;
    document.getElementById('progressText').textContent =
        `${currentBatch.currentIndex}/${total}`;
}

// æå‰ç»“æŸå­¦ä¹ 
async function endStudyEarly() {
    if (!confirm('ç¡®å®šè¦æå‰ç»“æŸå­¦ä¹ å—ï¼Ÿ')) {
        return;
    }

    try {
        await completeBatch();
        window.location.href = '/';
    } catch (error) {
        alert('ç»“æŸå¤±è´¥: ' + error.message);
    }
}

// æ˜¾ç¤ºç©ºçŠ¶æ€
function showEmptyState() {
    document.getElementById('studyContent').innerHTML = `
        <div class="empty-state">
            <p>æ²¡æœ‰å¯å­¦ä¹ çš„å†…å®¹</p>
            <a href="/" class="btn btn-primary">è¿”å›é¦–é¡µ</a>
        </div>
    `;
    document.getElementById('studyInput').style.display = 'none';
    document.getElementById('studyControls').style.display = 'none';
}

// æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
function showCompletionState() {
    document.getElementById('studyContent').innerHTML = `
        <div class="completion-state">
            <h3>ğŸ‰ å­¦ä¹ å®Œæˆï¼</h3>
            <p>æ‚¨å·²å®Œæˆæœ¬æ¬¡å­¦ä¹ è®¡åˆ’</p>
            <div class="actions">
                <button class="btn btn-primary" onclick="window.location.href='/'">è¿”å›é¦–é¡µ</button>
            </div>
        </div>
    `;
    document.getElementById('studyInput').style.display = 'none';
    document.getElementById('studyControls').style.display = 'none';
}

// é”™è¯¯å¤„ç†
function showError(message) {
    document.getElementById('studyContent').innerHTML = `
        <div class="error-state">
            <p>åŠ è½½å¤±è´¥: ${escapeHtml(message)}</p>
            <a href="/" class="btn btn-primary">è¿”å›é¦–é¡µ</a>
        </div>
    `;
    document.getElementById('studyInput').style.display = 'none';
    document.getElementById('studyControls').style.display = 'none';
}

// HTMLè½¬ä¹‰å‡½æ•°
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>
{% endblock %}
