{% extends "base.html" %}

{% block title %}背诵练习 - {{ deck.name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="practice-header">
        <h2>背诵练习 - {{ deck.name }}</h2>
        <div class="practice-controls">
            <div class="mode-selector">
                <label>学习模式:</label>
                <select id="practiceMode">
                    <option value="en_to_zh">显示英文，默写中文</option>
                    <option value="zh_to_en">显示中文，默写英文</option>
                </select>
            </div>
            <div class="practice-actions">
                <a href="{{ url_for('study_setup', deck_id=deck.id) }}" class="btn btn-secondary">重新设置</a>
                <a href="{{ url_for('decks') }}" class="btn btn-outline">返回学习库</a>
            </div>
        </div>
    </div>

    <div class="practice-container">
        <!-- 进度显示 -->
        <div class="progress-section">
            <div class="progress-info">
                <span id="progressText">0/{{ content_count }}</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- 内容显示区域 -->
        <div class="content-display" id="contentDisplay">
            <div class="loading-message">
                <p>加载内容中...</p>
            </div>
        </div>

        <!-- 答案输入区域 -->
        <div class="answer-section" id="answerSection" style="display: none;">
            <h3>请输入答案:</h3>
            <input type="text" id="answerInput" class="answer-input" placeholder="请输入答案...">
            <div class="answer-actions">
                <button class="btn btn-primary" id="submitAnswer">提交答案</button>
                <button class="btn btn-secondary" id="showAnswer">显示答案</button>
            </div>
        </div>

        <!-- 结果反馈区域 -->
        <div class="result-section" id="resultSection" style="display: none;">
            <div class="result-content">
                <h3 id="resultTitle">结果</h3>
                <div class="answer-comparison">
                    <div class="user-answer">
                        <strong>你的答案:</strong>
                        <span id="userAnswerText"></span>
                    </div>
                    <div class="correct-answer">
                        <strong>正确答案:</strong>
                        <span id="correctAnswerText"></span>
                    </div>
                </div>
                <div class="example-section" id="exampleSection" style="display: none;">
                    <strong>示例:</strong>
                    <p id="exampleText"></p>
                </div>
                <div class="result-actions">
                    <button class="btn btn-easy" id="tooEasyBtn">太简单了</button>
                    <button class="btn btn-next" id="nextContentBtn">下一个</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.practice-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e9ecef;
}

.practice-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.mode-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.mode-selector label {
    font-weight: 600;
    color: #2c3e50;
}

.mode-selector select {
    padding: 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 4px;
}

.practice-container {
    max-width: 600px;
    margin: 0 auto;
}

.progress-section {
    margin-bottom: 2rem;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.progress-bar {
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #3498db;
    transition: width 0.3s;
    width: 0%;
}

.content-display {
    background: white;
    padding: 3rem 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    text-align: center;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.content-text {
    font-size: 1.8rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 1rem;
}

.content-type {
    display: inline-block;
    background: #e9ecef;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    color: #6c757d;
    text-transform: uppercase;
}

.answer-section {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.answer-input {
    width: 100%;
    padding: 1rem;
    font-size: 1.2rem;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    margin-bottom: 1rem;
    transition: border-color 0.3s;
}

.answer-input:focus {
    outline: none;
    border-color: #3498db;
}

.answer-actions {
    display: flex;
    gap: 1rem;
}

.result-section {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.answer-comparison {
    margin-bottom: 1.5rem;
}

.user-answer, .correct-answer {
    margin-bottom: 1rem;
    padding: 1rem;
    border-radius: 6px;
}

.user-answer {
    background: #f8f9fa;
    border-left: 4px solid #6c757d;
}

.correct-answer {
    background: #e8f5e8;
    border-left: 4px solid #27ae60;
}

.example-section {
    padding: 1rem;
    background: #fff3e0;
    border-radius: 6px;
    border-left: 4px solid #f39c12;
}

.result-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.btn-easy {
    background-color: #95a5a6;
    color: white;
}

.btn-easy:hover {
    background-color: #7f8c8d;
}

.btn-next {
    background-color: #3498db;
    color: white;
}

.btn-next:hover {
    background-color: #2980b9;
}

.loading-message, .error-message {
    text-align: center;
    color: #6c757d;
    font-size: 1.1rem;
}

.correct .user-answer {
    border-left-color: #27ae60;
    background: #e8f5e8;
}

.incorrect .user-answer {
    border-left-color: #e74c3c;
    background: #f8d7da;
}
</style>

<script>
let currentContent = null;
let currentDeckId = {{ deck.id }};
let currentMode = '{{ default_mode }}';  // 使用传递的默认模式

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    // 设置模式选择框的值
    document.getElementById('practiceMode').value = currentMode;

    // 加载第一个内容
    loadNextContent();

    // 绑定事件
    document.getElementById('practiceMode').addEventListener('change', function() {
        currentMode = this.value;
        loadNextContent();
    });

    document.getElementById('submitAnswer').addEventListener('click', submitAnswer);
    document.getElementById('showAnswer').addEventListener('click', showAnswer);
    document.getElementById('tooEasyBtn').addEventListener('click', markAsTooEasy);
    document.getElementById('nextContentBtn').addEventListener('click', loadNextContent);

    // 回车提交答案
    document.getElementById('answerInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            submitAnswer();
        }
    });
});

// 加载下一个内容
async function loadNextContent() {
    // 显示加载状态
    document.getElementById('contentDisplay').innerHTML = `
        <div class="loading-message">
            <p>加载内容中...</p>
        </div>
    `;

    // 隐藏其他区域
    document.getElementById('answerSection').style.display = 'none';
    document.getElementById('resultSection').style.display = 'none';

    try {
        const params = new URLSearchParams({
            mode: currentMode
        });

        if (currentContent) {
            params.append('current_content_id', currentContent.id);
        }

        const response = await fetch(`/api/practice/next_content/${currentDeckId}?${params}`);
        const result = await response.json();

        if (result.success) {
            currentContent = result.content;
            displayContent(currentContent);
            updateProgress(result.progress);
        } else {
            showError(result.message);
        }
    } catch (error) {
        showError('加载失败: ' + error.message);
    }
}

// 显示内容
function displayContent(content) {
    const contentDisplay = document.getElementById('contentDisplay');

    contentDisplay.innerHTML = `
        <div>
            <div class="content-text">${content.display_text}</div>
            <span class="content-type">${content.type}</span>
        </div>
    `;

    // 设置输入框提示
    document.getElementById('answerInput').placeholder = content.input_placeholder;
    document.getElementById('answerInput').value = '';

    // 显示答案输入区域
    document.getElementById('answerSection').style.display = 'block';
    document.getElementById('answerInput').focus();
}

// 更新进度
function updateProgress(progress) {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    const percentage = (progress.current / progress.total) * 100;
    progressFill.style.width = `${percentage}%`;
    progressText.textContent = `${progress.current}/${progress.total}`;
}

// 提交答案
async function submitAnswer() {
    const userAnswer = document.getElementById('answerInput').value.trim();

    if (!userAnswer) {
        alert('请输入答案');
        return;
    }

    // 检查答案
    const isCorrect = userAnswer.toLowerCase() === currentContent.answer.toLowerCase();
    const feedbackType = isCorrect ? 'correct' : 'incorrect';

    // 提交反馈
    await submitFeedback(feedbackType, userAnswer);

    // 显示结果
    showResult(isCorrect, userAnswer);
}

// 显示答案
async function showAnswer() {
    const userAnswer = document.getElementById('answerInput').value.trim();
    const feedbackType = 'incorrect'; // 显示答案视为错误

    // 提交反馈
    await submitFeedback(feedbackType, userAnswer || '未作答');

    // 显示结果
    showResult(false, userAnswer || '未作答', true);
}

// 标记为太简单
async function markAsTooEasy() {
    await submitFeedback('too_easy', '');
    loadNextContent();
}

// 提交反馈到服务器
async function submitFeedback(feedbackType, userAnswer) {
    try {
        const response = await fetch('/api/practice/feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content_id: currentContent.id,
                feedback_type: feedbackType,
                user_answer: userAnswer
            })
        });

        const result = await response.json();
        if (!result.success) {
            console.error('反馈提交失败:', result.message);
        }
    } catch (error) {
        console.error('提交反馈失败:', error);
    }
}

// 显示结果
function showResult(isCorrect, userAnswer, showedAnswer = false) {
    const resultSection = document.getElementById('resultSection');
    const userAnswerText = document.getElementById('userAnswerText');
    const correctAnswerText = document.getElementById('correctAnswerText');
    const exampleSection = document.getElementById('exampleSection');
    const exampleText = document.getElementById('exampleText');
    const resultTitle = document.getElementById('resultTitle');

    // 设置结果标题
    if (showedAnswer) {
        resultTitle.textContent = '答案已显示';
    } else {
        resultTitle.textContent = isCorrect ? '回答正确！' : '回答错误';
    }

    // 设置答案对比
    userAnswerText.textContent = userAnswer;
    correctAnswerText.textContent = currentContent.answer;

    // 设置示例
    if (currentContent.example) {
        exampleText.textContent = currentContent.example;
        exampleSection.style.display = 'block';
    } else {
        exampleSection.style.display = 'none';
    }

    // 设置样式
    resultSection.className = 'result-section';
    if (isCorrect) {
        resultSection.classList.add('correct');
    } else {
        resultSection.classList.add('incorrect');
    }

    // 显示结果区域
    document.getElementById('answerSection').style.display = 'none';
    resultSection.style.display = 'block';
}

// 显示错误
function showError(message) {
    document.getElementById('contentDisplay').innerHTML = `
        <div class="error-message">
            <p>${message}</p>
            <button class="btn btn-primary" onclick="loadNextContent()">重试</button>
        </div>
    `;
}
</script>
{% endblock %}