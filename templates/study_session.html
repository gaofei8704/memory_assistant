{% extends "base.html" %}

{% block title %}å­¦ä¹ ä¼šè¯ - è®°å¿†åŠ©æ‰‹{% endblock %}

{% block content %}
<div class="container">
    <div class="study-header">
        <h2>å­¦ä¹ ä¼šè¯</h2>
        <div class="session-info">
            <div class="session-progress">
                <span id="progressText">0/0</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="endStudyEarly()">æå‰ç»“æŸ</button>
        </div>
    </div>

    <div class="study-content" id="studyContent">
        <div class="loading-message">
            <p>åŠ è½½å­¦ä¹ å†…å®¹ä¸­...</p>
        </div>
    </div>

    <div class="study-controls" id="studyControls" style="display: none;">
        <h3>ä½ è®°ä½äº†å—ï¼Ÿ</h3>
        <div class="feedback-buttons">
            <button class="btn btn-easy" onclick="markAsTooEasy()">
                <span>å¤ªç®€å•äº†</span>
                <small>æˆ‘å·²ç»å®Œå…¨è®°ä½</small>
            </button>
            <button class="btn btn-remember" onclick="submitFeedback('remembered')">
                <span>è®°ä½äº†</span>
                <small>æ­£ç¡®å›ç­”</small>
            </button>
            <button class="btn btn-forget" onclick="submitFeedback('forgotten')">
                <span>å¿˜è®°äº†</span>
                <small>éœ€è¦å¤ä¹ </small>
            </button>
        </div>
    </div>
</div>

<script>
// å½“å‰å­¦ä¹ ä¼šè¯çŠ¶æ€
let currentSession = {
    id: {{ session.id }},
    content: [],
    currentIndex: 0,
    startTime: Date.now()
};

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadStudySession();
});

// åŠ è½½å­¦ä¹ ä¼šè¯æ•°æ®
async function loadStudySession() {
    try {
        const response = await fetch(`/api/study/session/${currentSession.id}`);
        const result = await response.json();

        if (result.success) {
            currentSession.content = result.content;
            currentSession.currentIndex = 0;
            showCurrentContent();
            updateProgress();
        } else {
            showError(result.message || 'åŠ è½½å­¦ä¹ å†…å®¹å¤±è´¥');
        }
    } catch (error) {
        showError('ç½‘ç»œé”™è¯¯: ' + error.message);
    }
}

// æ˜¾ç¤ºå½“å‰å­¦ä¹ å†…å®¹
function showCurrentContent() {
    if (currentSession.content.length === 0) {
        showEmptyState();
        return;
    }

    if (currentSession.currentIndex >= currentSession.content.length) {
        showCompletionState();
        return;
    }

    const content = currentSession.content[currentSession.currentIndex];

    document.getElementById('studyContent').innerHTML = `
        <div class="content-card">
            <div class="content-front">
                <h3>${escapeHtml(content.display_text)}</h3>
                ${content.example ? `<p class="example">${escapeHtml(content.example)}</p>` : ''}
                <button class="btn btn-secondary" onclick="showAnswer()">æ˜¾ç¤ºç­”æ¡ˆ</button>
            </div>
            <div class="content-back" style="display: none;">
                <h3>${escapeHtml(content.answer)}</h3>
                ${content.example ? `<p class="example">${escapeHtml(content.example)}</p>` : ''}
                <button class="btn btn-secondary" onclick="showFeedbackControls()">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
    `;

    // é‡ç½®çŠ¶æ€
    document.getElementById('studyControls').style.display = 'none';
    currentSession.startTime = Date.now();
}

// æ˜¾ç¤ºç­”æ¡ˆ
function showAnswer() {
    document.querySelector('.content-front').style.display = 'none';
    document.querySelector('.content-back').style.display = 'block';
    showFeedbackControls();
}

// æ˜¾ç¤ºåé¦ˆæ§åˆ¶æŒ‰é’®
function showFeedbackControls() {
    document.getElementById('studyControls').style.display = 'block';
}

// æäº¤å­¦ä¹ åé¦ˆ
async function submitFeedback(feedbackType) {
    const responseTime = Math.floor((Date.now() - currentSession.startTime) / 1000);
    const currentContent = currentSession.content[currentSession.currentIndex];

    try {
        const response = await fetch('/api/study/feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: currentSession.id,
                content_id: currentContent.id,
                feedback_type: feedbackType,
                response_time: responseTime
            })
        });

        const result = await response.json();

        if (result.success) {
            moveToNextContent();
        } else {
            alert('æäº¤å¤±è´¥: ' + result.message);
        }
    } catch (error) {
        alert('è¯·æ±‚å¤±è´¥: ' + error.message);
    }
}

// æ ‡è®°ä¸ºå¤ªç®€å•
async function markAsTooEasy() {
    const currentContent = currentSession.content[currentSession.currentIndex];

    try {
        const response = await fetch('/api/study/mark_too_easy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content_id: currentContent.id,
                session_id: currentSession.id
            })
        });

        const result = await response.json();

        if (result.success) {
            moveToNextContent();
        } else {
            alert('æ ‡è®°å¤±è´¥: ' + result.message);
        }
    } catch (error) {
        alert('è¯·æ±‚å¤±è´¥: ' + error.message);
    }
}

// ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå†…å®¹
async function moveToNextContent() {
    currentSession.currentIndex++;

    // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆ
    if (currentSession.currentIndex >= currentSession.content.length) {
        await endStudySession(); // è‡ªåŠ¨ç»“æŸä¼šè¯
        showCompletionState();
    } else {
        showCurrentContent();
        updateProgress();
    }
}


// æ›´æ–°è¿›åº¦æ¡
function updateProgress() {
    const total = Math.max(currentSession.content.length, 1);
    const progress = (currentSession.currentIndex / total) * 100;

    document.getElementById('progressFill').style.width = `${progress}%`;
    document.getElementById('progressText').textContent =
        `${currentSession.currentIndex}/${total}`;
}

// æå‰ç»“æŸå­¦ä¹ 
async function endStudyEarly() {
    if (!confirm('ç¡®å®šè¦æå‰ç»“æŸå­¦ä¹ å—ï¼Ÿ')) {
        return;
    }

    try {
        const response = await fetch('/api/study/end', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: currentSession.id
            })
        });

        const result = await response.json();

        if (result.success) {
            window.location.href = '/';
        } else {
            alert('ç»“æŸå¤±è´¥: ' + result.message);
        }
    } catch (error) {
        alert('è¯·æ±‚å¤±è´¥: ' + error.message);
    }
}

// æ˜¾ç¤ºç©ºçŠ¶æ€
function showEmptyState() {
    document.getElementById('studyContent').innerHTML = `
        <div class="empty-state">
            <p>æ²¡æœ‰å¯å­¦ä¹ çš„å†…å®¹</p>
            <a href="/study/setup/{{ session.deck_id }}" class="btn btn-primary">è¿”å›è®¾ç½®</a>
        </div>
    `;
}
// æ›´æ–°å­¦ä¹ å®ŒæˆçŠ¶æ€æ˜¾ç¤º
function showCompletionState() {
    document.getElementById('studyContent').innerHTML = `        <div class="completion-state">
            <h3>ğŸ‰ å­¦ä¹ å®Œæˆï¼</h3>
            <p>æ‚¨å·²å®Œæˆæœ¬æ¬¡å­¦ä¹ è®¡åˆ’</p>
            <div class="actions">
                <button class="btn btn-primary" onclick="window.location.href='/'">è¿”å›é¦–é¡µ</button>
                <button class="btn btn-secondary" onclick="restartStudy()">é‡æ–°å­¦ä¹ </button>
            </div>
        </div>
    `;
}

// é”™è¯¯å¤„ç†
function showError(message) {
    document.getElementById('studyContent').innerHTML = `
        <div class="error-state">
            <p>åŠ è½½å¤±è´¥: ${escapeHtml(message)}</p>
            <a href="/study/setup/{{ session.deck_id }}" class="btn btn-primary">è¿”å›è®¾ç½®</a>
        </div>
    `;
}

// HTMLè½¬ä¹‰å‡½æ•°
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>
{% endblock %}
